<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/main.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yeon+Sung&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <title>Document</title>
</head>
<body>
    <!-- 이미지로 할시 -->
    <!-- 1. 아래 비디오 할 시를 주석 처리 -->
    <!-- 2. css의 html부분을 주석 해제 -->
    <!-- 비디오로 할 시 -->
    <div class="bg-video">
        <video class="bg-video__content" autoplay muted loop>
          <source src="./images/background.mp4" type="video/mp4" />
          <source src="./images/background.webm" type="video/webm" />
          Your browser is not supported!
        </video>
    </div>

    <header class="yeon-sung-regular custom-font">
        구해봐요
        <br>
        서울의 방
    </header>
    
    <div id="web-info" class="yeon-sung-regular">
        <구해봐요 서울의 방>은 살고 싶은 곳의 주소를 입력하면 입력한 주소 반경 내의 평균 월세, 전세 가격과 병원, 마트, 음식점 개수를 기반으로 추천하는 동네의 순위를 보여주는 웹사이트 입니다.   </div>


    <div class="search-form yeon-sung-regular">
        <button class="input-form" id="often-place" onclick="sample6_execDaumPostcode('often-place')" value="">
            <span>자주 가는 곳</span>
        </button>
        <button class="input-form" id="want-live-place" onclick="sample6_execDaumPostcode('want-live-place')", value="">
            <span value=1>살고 싶은 곳</span>
        </button>
        <div class="user-select-form">
        </div>
        <button class="input-form" id="search" value="" onclick="nextPage()">
            <span>추천 순위 검색</span>
        </button>
    </div>
    
 
</body>
</html>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    const searchData = []

    // 에숙파가 부릅니다 
    // Next Page;
    function nextPage(){
        const searchDataSize = searchData.length

        // 자주 가는 곳 선택 안한경우
        if(document.querySelector("#often-place").textContent === "\n            자주 가는 곳\n        "){
            alert("자주 가는 곳을 입력하세요.")
        }

        // 검색 데이터가 빈 경우
        else if(searchDataSize == 0){
            alert("살고 싶은 곳을 입력하세요.")
        }

        else {
            const oftenPlaceInput = document.querySelector("#often-place").textContent;
            console.log(oftenPlaceInput)

            const wantPlaceInput = searchData.map(div => div.outerText);
            console.log(wantPlaceInput)

            sendPlacesToServer(oftenPlaceInput, wantPlaceInput);
            window.location.href = "search.html"
        }
    }

    function serachForm(value){
        const form = `
            <div class="select-form" >
                <span> ${value} </span>
            </div>`
        return form
    }

    function removeData(value){
        const form = document.querySelector(".user-select-form");

        // 데이터 삭제
        const index = searchData.indexOf(value);
        if(index !== -1){
            searchData.splice(index, 1);
        }
        
        //form 초기화
        form.innerHTML = "";
        const listSize = searchData.length

        const newDiv = document.createElement("div");
        newDiv.style.fortSize = "10px";
        newDiv.textContent = `${listSize}/10`;
        form.appendChild(newDiv);

        searchData.forEach((data, index) => {
            form.appendChild(data);
        })
    }
    
    //카카오 API
    function sample6_execDaumPostcode(ID) {
        new daum.Postcode({
        width : 600, // 팝업 창의 너비
        height : 600, // 팝업 창의 높이
        left : 900, // 팝업 창의 가로 위치
        top : 400, // 팝업 창의 세로 위치
            oncomplete: function(data) {
                var addr = '';
                var extraAddr = ''; 

                if (data.userSelectedType === 'R') { 
                    addr = data.roadAddress;
                } else { 
                    addr = data.jibunAddress;
                }

                if(data.userSelectedType === 'R'){
                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                        extraAddr += data.bname;
                    }
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    if(extraAddr !== ''){
                        extraAddr = ' (' + extraAddr + ')';
                    }
                
                }

                // 우편번호와 주소 정보를 해당 필드에 넣는다.
                if(ID === "often-place"){
                    const oftenPlace = document.querySelector("#often-place");
                    oftenPlace.textContent = addr;
                }else {
                    const form = document.querySelector(".user-select-form");
                    const tempDiv = document.createElement("div");
                    tempDiv.addEventListener('click', () => {
                        removeData(tempDiv);
                    })
                    tempDiv.innerHTML = serachForm(addr);
                    
                    // 중복 확인
                    let isInclued = false;                    
                    searchData.forEach((data,index) => {
                        if(data.innerHTML === tempDiv.innerHTML){
                            isInclued = true;
                        }
                    })

                    console.log(isInclued);
                    
                    if(isInclued){
                        alert("중복된 주소입니다.");
                    }
                    else{
                        searchData.push(tempDiv);
                        const listSize = searchData.length
                        //form 초기화
                        form.innerHTML = "";
                        
                        const newDiv = document.createElement("div");
                        newDiv.style.fortSize = "10px";
                        newDiv.textContent = `${listSize}/10`;
                        form.appendChild(newDiv);

                        searchData.forEach((data, index) => {
                            form.appendChild(data);
                        })

                        // 10개일시
                        if(listSize == 10){
                            const temp = document.querySelector('#want-live-place');
                            temp.style.opacity = '0.5'; 
                            temp.setAttribute('disabled','true');
                            temp.style.pointerEvents = 'none';
                        }
                    }
                    
                }
                document.getElementById(ID).value = addr;
                document.getElementById(ID).focus();

            }
        }).open();
    }

    function sendPlacesToServer(oftenPlaceInput, wantPlaceInput) {
        //const oftenPlaceInput = document.getElementById('often-place');
        //const wantPlaceInput = document.getElementById('want-place');

        const requestData = {
            oftenPlace: oftenPlaceInput,
            wantPlace: wantPlaceInput,
        };
        console.log('requestData:', requestData);

        fetch('/api/get-oftenplace', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            console.log('서버 응답:', data);
        })
        .catch(error => {
            console.error('오류:', error);
        });
    }
   
</script>

<style>
/* 배경 이미지 */
/* html {
    background: url('images/main.jpg') no-repeat center fixed;  
    background-size: cover;
} */

/* 배경 동영상 */
.bg-video {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  width: 100%;
  z-index: -1;
}

.bg-video__content {
  height: 100%;
  width: 100%;
  object-fit: cover;
}

button {
    margin: 0;
    padding: 0;
    border: none;
    box-shadow: none;
    background: none;

    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    color: inherit;

    cursor: pointer;
    outline: none;
}

#web-info{
    position: absolute;
    top: 30vh;
    left: 20vh;
    
    width: 60vh;
    height: 50vh;
    font-size: 20px;
    color: white;
}

.search-form{
    /* background-color: red; */
    position: absolute;
    top:20vh;
    right: 15vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    border-radius: 8px;
    width: 55vh;
    height: 70vh;
}
body{
    margin: 0;
}

/* 구해봐요 서울의 방 위치 고정 */
.custom-font{
    position: absolute;
    top: 10vh;
    left: 20vh;
    font-size: 50px;
    color: white;
}

/* 입력창 */
.input-form{
    border-radius: 8px;
    border: 1px solid rgb(255, 177, 255);
    padding: 5px;
    background-color: white;
    text-align: center;
    width: 45vh;
    font-size: 15px;
    transition: all 1s;
    margin-bottom: 10px;
}

.input-form:hover {
    cursor: pointer;
    font-size: 17px;
    background-color: rgb(255, 177, 255);
    border:1px solid white;
    transition: all 0.5s, background-color 1.5s;
}

/* 유저가 선택한 위치 */
.user-select-form{
    background-color: white;
    width: 43.5vh;
    height: 40vh;
    border-radius: 8px;
    border: 1px solid rgb(255, 177, 255);
    padding: 5px;
    transition: all 0.5s;
    margin-bottom: 10px;
}
.select-form{
    display: flex;
    justify-content: center;
    align-items: center;
    height: 3vh;
    background-color: white;
    border-radius: 8px;
}
.select-form:hover{
    cursor: pointer;
    background-color: lightcoral;
    transition: all 0.5s;
}

#search:hover{
    font-size: 30px;
    transition: all 1s;
}

.material-symbols-outlined {
  font-variation-settings:
  'FILL' 0,
  'wght' 400,
  'GRAD' 0,
  'opsz' 24
}
</style>